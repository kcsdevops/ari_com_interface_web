{% extends 'base.html' %}

{% block title %}Execute ARI{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h1>Run Azure Resource Inventory (ARI)</h1>
            <p class="lead">Execute o Azure Resource Inventory para coletar dados de recursos e custos.</p>
            
            <div class="card shadow">
                <div class="card-body">
                    <form id="ariForm">
                        <div class="mb-3">
                            <label for="tenantId" class="form-label">Tenant ID</label>
                            <input type="text" class="form-control" id="tenantId" name="tenantId" 
                                value="{{ user.tenant_id }}" placeholder="Ex: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                            <div class="form-text">O ID do Azure Active Directory Tenant.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="subscriptionIds" class="form-label">Subscription IDs (opcional)</label>
                            <textarea class="form-control" id="subscriptionIds" name="subscriptionIds" 
                                rows="3" placeholder="Um ID por linha ou separados por vírgula"></textarea>
                            <div class="form-text">Deixe em branco para incluir todas as assinaturas.</div>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="includeCosts" name="includeCosts" checked>
                            <label class="form-check-label" for="includeCosts">Incluir dados de custos</label>
                        </div>
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="includeTags" name="includeTags" checked>
                            <label class="form-check-label" for="includeTags">Incluir tags</label>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="executeBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="loadingSpinner"></span>
                            Executar ARI
                        </button>
                    </form>
                </div>
            </div>
            
            <div class="mt-4" id="resultArea" style="display: none;">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        Execução Iniciada
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" id="executionTitle">Processando...</h5>
                        <p class="card-text" id="executionMessage"></p>
                        <div class="mt-3">
                            <strong>Execution ID:</strong> <span id="executionId"></span>
                        </div>
                        <div class="mt-2">
                            <strong>Status:</strong> <span id="executionStatus"></span>
                        </div>
                        <div class="mt-4">
                            <a href="/executions" class="btn btn-outline-primary">Ver Todas as Execuções</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ariForm = document.getElementById('ariForm');
    const executeBtn = document.getElementById('executeBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultArea = document.getElementById('resultArea');
    const executionTitle = document.getElementById('executionTitle');
    const executionMessage = document.getElementById('executionMessage');
    const executionId = document.getElementById('executionId');
    const executionStatus = document.getElementById('executionStatus');
    
    ariForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading state
        executeBtn.disabled = true;
        loadingSpinner.classList.remove('d-none');
        
        // Get form data
        const tenantId = document.getElementById('tenantId').value.trim();
        const subscriptionIdsText = document.getElementById('subscriptionIds').value.trim();
        const includeCosts = document.getElementById('includeCosts').checked;
        const includeTags = document.getElementById('includeTags').checked;
        
        // Parse subscription IDs
        const subscriptionIds = subscriptionIdsText 
            ? subscriptionIdsText.split(/[\n,]/).map(id => id.trim()).filter(id => id) 
            : [];
        
        // Prepare request data
        const requestData = {
            tenant_id: tenantId,
            subscription_ids: subscriptionIds,
            include_costs: includeCosts,
            include_tags: includeTags
        };
        
        // Send request to API
        fetch('/api/run-ari', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            // Re-enable button and hide spinner
            executeBtn.disabled = false;
            loadingSpinner.classList.add('d-none');
            
            // Show result area
            resultArea.style.display = 'block';
            
            if (data.status === 'success') {
                executionTitle.textContent = 'Execução Iniciada com Sucesso';
                executionMessage.textContent = data.message;
                executionId.textContent = data.execution_id;
                executionStatus.textContent = 'Em Execução';
                executionStatus.className = 'text-warning';
            } else {
                executionTitle.textContent = 'Erro ao Iniciar Execução';
                executionMessage.textContent = data.error || 'Ocorreu um erro desconhecido';
                executionId.textContent = 'N/A';
                executionStatus.textContent = 'Falha';
                executionStatus.className = 'text-danger';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Re-enable button and hide spinner
            executeBtn.disabled = false;
            loadingSpinner.classList.add('d-none');
            
            // Show error in result area
            resultArea.style.display = 'block';
            executionTitle.textContent = 'Erro ao Iniciar Execução';
            executionMessage.textContent = 'Ocorreu um erro ao comunicar com o servidor';
            executionId.textContent = 'N/A';
            executionStatus.textContent = 'Falha';
            executionStatus.className = 'text-danger';
        });
    });
});
</script>
{% endblock %}
